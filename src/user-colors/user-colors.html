<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="user-color-block.html">

<dom-module id="colorsea-user-colors">
  <template>
    <style>
      user-color-block {
        cursor: pointer;
      }
    </style>

    <iron-ajax
      id="colorsAjax"
      url="/api/users/{{ user._id }}/color-schemes"
      handle-as="json"
      on-response="_colorsResponse"></iron-ajax>
    <p id="test">{{ _selectedSchemeIndex }} selected</p>

    <template is="dom-repeat" items="{{ userColorsÂ }}" index-as="i">
      <user-color-block on-tap="_colorBlockTapped" index="{{ i }}" data-foo="bar" colors="{{ item.colors }}"></user-color-block>
    </template>

  </template>
  <script>
  Polymer({
    is: 'colorsea-user-colors',

    properties: {
      user: {
        type: Object,
        notify: true,
      },

      userColors: {
        type: Array,
        notify: true,
      },

      selectedColorScheme: {
        type: Object,
        notify: true,
      },

      editingId: {
        type: String,
        notify: true,
      },

      _selectedSchemeIndex: {
        type: Number,
      }
    },

    observers: [
      'userUpdated(user)',
      'userColorsUpdated(userColors)',
      '_selectedIndexChanged(_selectedSchemeIndex)',
      '_selectedColorSchemeChanged(selectedColorScheme.colors.*)',
    ],

    userUpdated: function(user) {
      // console.log(user);
      if (user && user._id) {
        // console.log(user._id);
        this.$.colorsAjax.generateRequest();
      } else {
        this.set('userColors', []);
      }
    },

    userColorsUpdated: function(colors) {
      // console.log(colors);
      if (colors.length > 0) {
        this.set('_selectedSchemeIndex', 0);
      } else {
        this.set('_selectedSchemeIndex', -1);
      }
    },

    _colorsResponse: function(e, detail) {
      // console.log(detail.response);
      this.set('userColors', detail.response);
    },

    _colorBlockTapped: function(e, detail) {
      var target = Polymer.dom(e).localTarget;
      // console.log(block, this.editingId);
      this.set('_selectedSchemeIndex', target.index);
      this.async(function() {
        var block = Polymer.dom(e).rootTarget;
        this.set('editingId', block.id);
      });
    },

    _selectedIndexChanged: function(index) {
      // console.log(this.userColors);
      this.set('selectedColorScheme', this.get(['userColors', index]));
    },

    _selectedColorSchemeChanged: function() {
      console.log("color scheme changed");
      this.set(['userColors', this._selectedSchemeIndex], this.selectedColorScheme);
      console.log(this.userColors, this.selectedColorScheme.colors);
    },
  });
  </script>
</dom-module>
