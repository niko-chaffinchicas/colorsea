<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="elements/color-editing-panel/color-editing-panel.html">
<link rel="import" href="elements/color-block/color-block.html">
<link rel="import" href="../bower_components/iron-cookie/iron-cookie.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<!-- <link rel="import" href="../bower_components/google-signin/google-signin.html"> -->

<dom-module id="picker-view">
  <template>
    <style include="shared-styles">
      .color-block-wrapper {
        position: absolute;
        top: var(--top-offset, 0);
        right: 0;
        bottom: 0;
        left: 0;
      }

      color-block {
        position: absolute;
        height: 25%;
        width: 100%;
        top: 0;
        left: 0;
        cursor: pointer;
      }

      color-block[randomizing] {
        transition: background-color 0.15s ease;
      }

      .panel-wrapper {
        position: absolute;
        top: var(--top-offset, 0);
        right: 0;
        bottom: 0;
        background-color: white;
        overflow-y: auto;
      }

      color-editing-panel {
        width: 305px;
      }

      .color-block-pointer {
        position: absolute;
        width: 0;
        height: 0;
        top: 0;
        right: 385px;
        border-top: 2em solid transparent;
        border-bottom: 2em solid transparent;
        border-right: 1em solid white;
        transform: translate(0, -50%);
        transition: top 0.15s ease;
        z-index: 10;
      }
    </style>

    <iron-a11y-keys id="a11y" keys="space" on-keys-pressed="_spacePressed"></iron-a11y-keys>

    <!-- <iron-cookie name="colorsea_identity" value="{{ _userCookie }}"></iron-cookie> -->
    <iron-ajax
      id="getLastColorAjax"
      url="/api/colorschemes/{{ userCookie.last }}"
      handle-as="json"
      on-response="_lastColorResponse"></iron-ajax>


    <div class="color-block-wrapper">
      <div class="color-block-pointer" style$="top: {{ _getPointerOffset(_editingIndex) }};"></div>
      <template is="dom-repeat" items="{{ colorObjects }}" as="color" index-as="i">
        <color-block
          color-index="{{ i }}"
          color-id="{{ color._id }}"
          on-tap="_onColorBlockTap"
          on-focus="_onColorBlockFocus"
          class="color-block"
          hex="{{ color.hex }}"
          randomizing="{{ _updating }}"
          style$="top: {{ _getBlockOffset(i) }}; height: {{ _getBlockWidth(colorObjects) }}; background-color:#{{ color.hex }};"></color-block>
      </template>
    </div>

    <div class="panel-wrapper">
      <!-- <google-signin client-id="135843097633-g1mf96er6e8vrfhb1uvtoqlftkhfm3ec.apps.googleusercontent.com"></google-signin> -->
      <color-editing-panel hex="{{ _editingColor }}"></color-editing-panel>
    </div>
  </template>

  <script>
    Polymer({
      is: 'picker-view',

      properties: {
        colorScheme: {
          type: Object,
          notify: true,
        },

        colorObjects: {
          type: Array,
          notify: true,
          value: function() {
            return [];
          }
        },

        _last: {
          type: Array,
          value: function() {
            return [];
          }
        },

        _editingColor: {
          type: String,
          observer: '_editingColorChanged'
        },

        _editingIndex: {
          type: Number,
          value: -1,
          observer: '_editingIndexChanged'
        },

        editingId: {
          type: String,
          value: '123',
          observer: 'editingIdChanged'
        },

        _updating: {
          type: Boolean,
          value: false,
        },

        _colorLoaded: {
          type: Boolean,
          value: false,
        },
      },

      keyBindings: {
        'space': '_spacePressed'
      },

      observers: [
        '_colorSchemeChanged(colorObjects.*)',
        '_colorSchemeIdChanged(colorScheme._id)'
      ],

      listeners: {
        'hex-changed': '_onHexChanged'
      },

      _loadColorObjects: function(objects) {
        this._startUpdating();
        this.set('colorObjects', objects);
        this.async(function() {
          this.set('editingId', this.colorObjects[0]._id);
        });
      },

      _colorSchemeIdChanged: function(id) {
        // console.log(id);
        this._loadColorObjects(this.colorScheme.colors);
      },

      _lastColorResponse: function(e, detail) {
        // console.log(detail.response.colors);
        this.set('colorObjects', JSON.parse(JSON.stringify(detail.response.colors)));
        this.set('_last', JSON.parse(JSON.stringify(detail.response.colors)));
        this.async(function() {
          this.set('editingId', this.colorObjects[0]._id);
          this.set('_colorLoaded', true);
        });
      },

      _updatedColorResponse: function(e, detail) {
        // console.log("color changes saved");
      },

      _getBlockOffset: function(i) {
        return (100 / this.colorObjects.length * i) + "%";
      },

      _getPointerOffset: function(i) {
        return this._getBlockOffset(i+0.5);
      },

      _getBlockWidth: function(colorObjects) {
        return (100 / colorObjects.length) + "%";
      },

      _onColorBlockFocus: function(e) {
        var target = Polymer.dom(e).localTarget;
        if (target.nodeName.toLowerCase() == "color-block" && target.hasOwnProperty("colorId")) {
          this.set('editingId', target.colorId);
        }
      },

      _onHexChanged: function(e) {
        var target = Polymer.dom(e).rootTarget;
        // console.log(target);
        if (target.nodeName.toLowerCase() == "color-block" && target.hasOwnProperty("colorId")) {
          if (this._updating && target.colorId != this.editingId) {
            return;
          }
          this.set('editingId', target.colorId);
          if (this._editingColor != target.hex) {
            this.set('_editingColor', target.hex);
          }
        } else if (target.nodeName.toLowerCase() == "color-editing-panel" && this.colorObjects) {
          for (var i = 0; i < this.colorObjects.length; i++) {
            if (this.colorObjects[i]._id == this.editingId) {
              color = this.colorObjects[i];
              break;
            }
          }
          this.set(['colorObjects', i, 'hex'], this._editingColor);
        }
      },

      _onColorBlockTap: function(e, detail) {
        var target = Polymer.dom(e).localTarget;
        this.set('editingId', target.colorId);
      },

      _editingIndexChanged: function(i) {
        // console.log(i);
      },

      editingIdChanged: function(id) {
        // console.log(id);
        var color;
        for (var i = 0; i < this.colorObjects.length; i++) {
          if (this.colorObjects[i]._id == id) {
            color = this.colorObjects[i];
            break;
          }
        }
        if (color) {
          // console.log(color, i);
          this.set('_editingIndex', i);
          this.set('_editingColor', color.hex);
        }
      },

      _editingColorChanged: function(val) {
        // console.log(val);
        this.set(['colorObjects', this._editingIndex, 'hex'], val);
        // var colors = this.colors;
        // this.set('colors', []);
        // this.set('colors', colors);
      },

      _randomizeHexColors: function(num) {
        var output = [];
        for (var i = 0; i < num; i++) {
          var rgb = [];
          for (var j = 0; j < 3; j++) {
            var v = Math.floor((Math.random() * 255));
            rgb.push(v);
          }
          rgb = rgb.reduce(function(a, b) {
            _b = b.toString('16');
            if (_b.length == 1) {
              _b = "0" + _b;
            }
            return a + _b;
          }, "");
          var d = new Date().getTime();
          var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
              var r = (d + Math.random()*16)%16 | 0;
              d = Math.floor(d/16);
              return (c=='x' ? r : (r&0x3|0x8)).toString(16);
          });
          output.push({ _id: uuid, hex: rgb });
        }
        return output;
      },

      _startUpdating: function() {
        var self = this;
        window.clearTimeout(self._updatingTimeout);
        document.activeElement.blur();
        this.set('_updating', true);

        self._randomizingTimeout = setTimeout(function () {
          self.set('_updating', false);
        }, 200);
      },

      _spacePressed: function(e) {
        // console.log("space pressed", e);
        e.stopPropagation();
        var randomColors = this._randomizeHexColors(4);
        var _colorObjects = JSON.parse(JSON.stringify(this.colorObjects));
        for (var i = 0; i < randomColors.length; i++) {
          _colorObjects[i].hex = randomColors[i].hex;
        }
        this._loadColorObjects(_colorObjects);
        // this.set('_randomizing', false);
      },

      _colorSchemesEqual: function(colors1, colors2) {
        for (var i = 0; i < colors1.length; i++) {
          // console.log(colors1[i].hex, colors2[i].hex);
          if (colors1[i].hex !== colors2[i].hex) {
            return false;
          }
        }
        return true;
      },

      _colorSchemeChanged: function() {
        if (this._colorLoaded) {
          if (!this._colorSchemesEqual(this.colorObjects, this._last)) {
            // console.log("changing colors...");
            if (this.__changeTimeout) {
              this.cancelAsync(this.__changeTimeout);
            }
            var self = this;
            var _timeout = this.async(function() {
              // console.log("the color scheme has changed");
              this.$.colorSchemeAjax.body = JSON.stringify({ colors: this.colorObjects });
              this.$.colorSchemeAjax.generateRequest();
            }, 500);
            this.set('__changeTimeout', _timeout);
          }
        }
      },

      ready: function() {
        this.$.a11y.target = document.querySelector('body');
        // this.set('colorObjects', this._randomizeHexColors(4));
        // this.set('editingId', this.colorObjects[0]._id);
        // this.set('_editingIndex', 0);
      }
    });
  </script>
</dom-module>
