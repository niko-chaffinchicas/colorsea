<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="elements/color-editing-panel/color-editing-panel.html">
<link rel="import" href="elements/color-block/color-block.html">

<dom-module id="picker-view">
  <template>
    <style include="shared-styles">
      .color-block-wrapper {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
      }

      color-block {
        position: absolute;
        height: 25%;
        width: 100%;
        top: 0;
        left: 0;
        cursor: pointer;
      }

      .panel-wrapper {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        background-color: white;
        overflow-y: auto;
      }

      color-editing-panel {
        width: 305px;
      }

      .color-block-pointer {
        position: absolute;
        width: 0;
        height: 0;
        top: 0;
        right: 385px;
        border-top: 2em solid transparent;
        border-bottom: 2em solid transparent;
        border-right: 1em solid white;
        transform: translate(0, -50%);
        transition: top 0.15s ease;
        z-index: 10;
      }
    </style>

    <div class="color-block-wrapper">
      <div class="color-block-pointer" style$="top: {{ _getPointerOffset(_editingIndex) }};"></div>
      <template is="dom-repeat" items="{{ colorObjects }}" as="color" index-as="i">
        <color-block
          color-index="{{ i }}"
          color-id="{{ color._id }}"
          on-tap="_onColorBlockTap"
          on-focus="_onColorBlockFocus"
          class="color-block"
          hex="{{ color.hex }}"
          style$="top: {{ _getBlockOffset(i) }}; height: {{ _getBlockWidth(colors) }}; background-color:#{{ color.hex }};"></color-block>
      </template>
    </div>

    <div class="panel-wrapper">
      <color-editing-panel hex="{{ _editingColor }}"></color-editing-panel>
    </div>
  </template>

  <script>
    Polymer({
      is: 'picker-view',
      properties: {
        colors: {
          type: Array,
          notify: true,
          value: function() {
            return [
              'cbf9da',
              '3dd2cc',
              '3e6b89',
              '122d42'
            ]
          }
        },
        colorObjects: {
          type: Array,
          notify: true,
          value: function() {
            return [
              {
                _id: '123',
                hex: 'cbf9da',
              },
              {
                _id: '234',
                hex: '3dd2cc',
              },
              {
                _id: '345',
                hex: '3e6b89',
              },
              {
                _id: '456',
                hex: '122d42',
              }
            ]
          }
        },
        _editingColor: {
          type: String,
          observer: '_editingColorChanged'
        },
        _editingIndex: {
          type: Number,
          value: 0,
          observer: '_editingIndexChanged'
        },
        _editingId: {
          type: String,
          value: '123',
          observer: '_editingIdChanged'
        }
      },

      listeners: {
        'hex-changed': '_onHexChanged'
      },

      _getBlockOffset: function(i) {
        return (100 / this.colors.length * i) + "%";
      },

      _getPointerOffset: function(i) {
        return this._getBlockOffset(i+0.5);
      },

      _getBlockWidth: function(colors) {
        return (100 / colors.length) + "%";
      },

      _onColorBlockFocus: function(e) {
        var target = Polymer.dom(e).localTarget;
        if (target.nodeName.toLowerCase() == "color-block" && target.hasOwnProperty("colorId")) {
          this.set('_editingIndex', target.colorId);
        }
      },

      _onHexChanged: function(e) {
        // console.log(e);
        var target = Polymer.dom(e).rootTarget;
        console.log("hex changed:", target.hex, target);
        if (target.nodeName.toLowerCase() == "color-block" && target.hasOwnProperty("colorId")) {
          this.set('_editingId', target.colorId);
          if (this._editingColor != target.hex) {
            this.set('_editingColor', target.hex);
          }
        } else if (target.nodeName.toLowerCase() == "color-editing-panel" && this.colorObjects) {
          console.log("change came from color-editing-panel");
          for (var i = 0; i < this.colorObjects.length; i++) {
            if (this.colorObjects[i]._id == this._editingId) {
              color = this.colorObjects[i];
              break;
            }
          }
          this.set(['colorObjects', i, 'hex'], this._editingColor);
          // color.hex = this._editingColor;
          console.log(this.colorObjects);
        }
      },

      _onColorBlockTap: function(e, detail) {
        var target = Polymer.dom(e).localTarget;
        console.log(target);
        // this.set('_editingIndex', target.colorIndex);
        this.set('_editingId', target.colorId);
      },

      _editingIndexChanged: function(i) {
        // console.log("editing index changed:", i);
        // this.set('_editingColor', this.colors[i]);
      },

      _editingIdChanged: function(id) {
        // console.log("editing id changed:", id);
        var color;
        for (var i = 0; i < this.colorObjects.length; i++) {
          if (this.colorObjects[i]._id == id) {
            color = this.colorObjects[i];
            break;
          }
        }
        this.set('_editingColor', color.hex);
        this.set('_editingIndex', i);
      },

      _editingColorChanged: function(val) {
        this.set(['colors', this._editingIndex], val);
        var colors = this.colors;
        this.set('colors', []);
        this.set('colors', colors);
      },

      ready: function() {
        // this.set('_editingIndex', this.colorObjects[0]._id);
      }
    });
  </script>
</dom-module>
